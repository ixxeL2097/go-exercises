# https://taskfile.dev

version: "3"

tasks:
  build:
    desc: Build docker image for lambda microservice
    vars:
      TAG: '{{ .TAG | default "test" }}'
    cmds:
      - |
        docker buildx build --no-cache \
                            -t lambda:{{ .TAG }} .

  build:podman:
    desc: Build docker image for lambda microservice
    vars:
      TAG: '{{ .TAG | default "test" }}'
    cmds:
      - |
        podman build -t lambda:{{ .TAG }} .

  push:
    desc: Build docker image for lambda microservice
    vars:
      TAG: '{{ .TAG | default "test" }}'
      REGISTRY: '{{ .REGISTRY | default "ixxel" }}'
    cmds:
      - |
        docker tag lambda:{{ .TAG }} {{ .REGISTRY }}/lambda:{{ .TAG }}
        docker push {{ .REGISTRY }}/lambda:{{ .TAG }}

  run:docker:
    desc: run the server locally with Docker
    vars:
      PORT: '{{ .PORT | default "8081" }}'
      TAG: '{{ .TAG | default "test" }}'
    cmds:
    - docker run --name lambda -d -e APP_PORT={{ .PORT }} -p {{ .PORT }}:{{ .PORT }} lambda:{{ .TAG }}
